@page
@model TravelAppUI.Pages.PaymentModel
@{
    ViewData["Title"] = "Payment";
}

<h1>Stripe Payment</h1>

<form id="payment-form">
    <div id="payment-element">
        <!-- Stripe.js will create form elements here -->
    </div>
    <button id="submit" class="btn btn-primary mt-3">Pay Now</button>
    <div id="error-message" role="alert" class="mt-2 text-danger"></div>
</form>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const stripe = Stripe('@Model.PublishableKey');

            // --- 1. Create a Payment Intent on your server ---
            // In a real application, you would get these values dynamically,
            // for example from the booking page or query string.
            const bookingDetails = {
                bookingId: '00000000-0000-0000-0000-000000000001', 
                amount: 199.99,
                currency: 'usd'
            };

            const response = await fetch('/api/v1/payments/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingDetails)
            });

            const { clientSecret } = await response.json();

            // --- 2. Initialize the Payment Element ---
            const elements = stripe.elements({ clientSecret });
            const paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');

            // --- 3. Handle the form submission ---
            const form = document.getElementById('payment-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                setLoading(true);

                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        // Make sure to change this to your payment completion page
                        return_url: `${window.location.origin}/BookingConfirmation`,
                    },
                });

                // This point will only be reached if there is an immediate error when
                // confirming the payment. Otherwise, your customer will be redirected to
                // your `return_url`.
                if (error) {
                    if (error.type === "card_error" || error.type === "validation_error") {
                        showMessage(error.message);
                    } else {
                        showMessage("An unexpected error occurred.");
                    }
                }

                setLoading(false);
            });
        });

        // --- UI helpers ---
        function showMessage(messageText) {
            const messageContainer = document.querySelector("#error-message");
            messageContainer.textContent = messageText;
            setTimeout(() => { messageContainer.textContent = ""; }, 4000);
        }

        function setLoading(isLoading) {
            const submitButton = document.querySelector("#submit");
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            } else {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Pay Now';
            }
        }
    </script>
}
